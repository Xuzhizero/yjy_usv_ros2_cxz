# 开发日志：Simulink 与 UE5 联合仿真调速性能分析

**Tags:** `simulation`, `ue5`, `simulink`, `performance`, `co-simulation`, `real-time`

**日期**: 2025-12-21
**状态**: 已完成 (Completed)
**记录人**: 陈喜忠 (Xuzhizero)

---

## 1. 项目背景与环境 (Project Context)

### 1.1 研究机构与目标

* **研究机构**：浙江省智能船舶研究院
* **仿真目标**：实现无人船（USV）位姿实时映射与感知数据（相机画面）闭环回传
* **技术栈**：Simulink + UE5 + Simulation 3D 工具箱

### 1.2 USV 物理参数

本次仿真使用的无人船具有以下物理参数：

| 参数 | 数值 | 单位 | 备注 |
|------|------|------|------|
| **船长** | 32.6 | m | 中型无人水面船 |
| **恒定航速** | 7 | m/s | 约 13.6 节 |
| **角速度** | 0.5 | °/s | 转向速率 |
| **回转半径** | ~800 | m | 基于航速和角速度计算 |
| **完整回转时间** | ~12 | 分钟 | 360° 回转所需时间 |

### 1.3 仿真场景

* **场景类型**：港口环境
* **场景尺寸**：
  * 长度：约 880m
  * 宽度：约 570m
* **环境要素**：海洋、港口建筑、航道标识等

---

## 2. 问题描述 (Problem Statement)

### 2.1 纯 Simulink 环境表现

在**不连接 UE5 的纯 Simulink 环境**下，系统展现了优异的实时性能：

* ✅ **完美 1:1 实时仿真调速**
* ✅ **逻辑计算与理论时间高度匹配**
* ✅ **无调速警告或错误**
* ✅ **CPU/内存占用低**

**验证证据**：

下图展示了纯 Simulink 环境下的测试结果。通过秒表记录，仿真时间与真实时间完美同步：

![Simulink 纯环境测试 - 配置1](img/simulink_pure_test_1.png)
*图1: Simulink 模型配置，显示 VesselCommand 和 VesselStates 模块及信号连接*

![Simulink 纯环境测试 - 配置2](img/simulink_pure_test_2.png)
*图2: 相同的 Simulink 模型配置，显示不同的测试参数值*

**实时性验证**：

使用秒表记录真实时间，与仿真时间进行对比：

![实时测试 - 开始时间](img/realtime_test_stopwatch_start.png)
*图3: 测试开始时间 - 12:01.20*

![实时测试 - 结束时间](img/realtime_test_stopwatch_end.png)
*图4: 测试结束时间 - 12:03.86*

**结论**：真实经过时间约为 2分43秒 (163秒)，与仿真内部时间完全匹配，证明纯 Simulink 环境下可实现 **1:1 实时调速**。

### 2.2 接入 UE5 后的性能退化

然而，**接入 UE5 联合仿真后**，系统性能出现明显下降：

* ❌ **仿真进程明显变慢**
* ❌ **频繁出现调速警告**
* ❌ **无法达到指定的实时速率**

**典型错误提示**：

```
⚠️ 调速处于活动状态,但无法以指定的速率调速
   (Simulation pacing is active, but it cannot pace at the specified rate)
```

**问题特征**：
- 即使在开启调速模式下，系统仍无法保持实时
- 警告频繁出现，打断仿真流程
- 用户体验明显下降

---

## 3. 性能影响因素分析 (Factor Analysis)

### 3.1 求解器与采样时间 (Solver & Sample Time)

#### 3.1.1 求解器类型优化

**初始配置**：
* 求解器类型：自动 (Auto) - 变步长求解器
* 问题：变步长带来额外计算开销，且与 UE5 同步困难

**优化后配置**：
* 求解器类型：**定步长 (Fixed-step)**
* 优势：
  * ✅ 消除变步长计算开销
  * ✅ 简化时间同步逻辑
  * ✅ 提高可预测性

#### 3.1.2 时钟一致性要求

**关键配置**：必须确保 `Simulation 3D Scene Configuration` 与控制逻辑的 `Sample Time` 保持一致。

**推荐配置**：
```matlab
% 所有模块统一采样时间
Sample_Time = 0.02;  % 50 Hz

% Simulation 3D Scene Configuration
% - Sample Time: 0.02s

% 控制器模块
% - Sample Time: 0.02s

% 传感器模块
% - Sample Time: 0.02s 或其整数倍
```

**不匹配的风险**：

| 场景 | 位姿更新频率 | UE5 更新频率 | 后果 |
|------|-------------|-------------|------|
| ❌ 不匹配 | 0.01s (100Hz) | 0.05s (20Hz) | 阶跃效应、虚假加速度 |
| ✅ 匹配 | 0.02s (50Hz) | 0.02s (50Hz) | 平滑运动、数据准确 |

**数据混叠风险示例**：

```
时间轴:  0    0.01  0.02  0.03  0.04  0.05  0.06  ...
位姿更新: ●    ●     ●     ●     ●     ●     ●     ... (100Hz)
UE5更新:  ●                 ●                 ●     ... (20Hz)
         ↑                 ↑                 ↑
      采样点1            采样点2            采样点3

结果: 船只每隔 5 步"跳跃"一次
影响: IMU 检测到虚假加速度冲击，雷达产生错误回波
```

#### 3.1.3 速率转换策略

**场景需求**：
- 控制回路需要高频更新 (50-100 Hz)
- 图像回传可以接受较低频率 (10-30 Hz)

**解决方案**：
* 开启 **自动数据传输速率转换** (Automatic Rate Transition)
* 为不同子系统设置合理的采样时间

**工业标准实践**：
> 在实时仿真中，牺牲视觉采样频率以换取整体系统性能是常用且有效的折衷方案。

**典型配置**：
```
控制逻辑:      50 Hz  (0.02s)
位姿同步:      50 Hz  (0.02s)
UE5 渲染:      30 Hz  (0.033s)
图像回传:      20 Hz  (0.05s)
数据记录:      10 Hz  (0.1s)
```

### 3.2 分辨率与传输开销 (Resolution & Data Transfer)

#### 3.2.1 相机分辨率优化

**优化措施**：

| 参数 | 原始值 | 优化值 | 数据量减少 |
|------|--------|--------|-----------|
| 分辨率 | 1920×1080 | 640×480 | ~85% |
| 每帧数据 | ~6MB | ~0.9MB | 显著降低 |
| 传输时间 (估算) | ~50ms | ~8ms | 提升 6倍+ |

**实施方法**：
```matlab
% Simulation 3D Camera Get 模块配置
% Image size: [480, 640]  % [Height, Width]
% Format: RGB8
```

#### 3.2.2 UE5 渲染分辨率

**影响范围**：
* UE5 编辑器窗口分辨率
* 独立运行窗口分辨率
* 离屏渲染 (Off-screen rendering) 分辨率

**优化建议**：
```
编辑器预览:    1280×720  (快速迭代)
仿真运行:      640×480   (匹配 Simulink)
最终验证:      1920×1080 (高质量验证)
```

---

## 4. 核心瓶颈分析：串行"接力赛"机制 (Serial Bottleneck)

### 4.1 硬件资源使用情况

**实测数据**：
* **CPU 占用**：~10%
* **GPU 占用**：~26%
* **内存占用**：~70%

**关键观察**：
> 尽管硬件资源占用处于较低水平，仿真依然无法达到实时。这揭示了性能瓶颈并非"吞吐量"不足，而是**"逻辑时延"**导致的同步阻塞。

### 4.2 串行接力过程分析

联合仿真本质上是一个**串行接力过程**，无法通过硬件并行化解决：

```
步骤1: Simulink 计算          → 耗时: ~5ms
        ↓ (数据传输)
步骤2: 位姿发送至 UE5         → 耗时: ~2ms
        ↓ (等待渲染)
步骤3: UE5 渲染当前帧         → 耗时: ~16ms (60 FPS) 或 ~33ms (30 FPS)
        ↓ (GPU → CPU)
步骤4: 图像 Readback          → 耗时: ~10-20ms ⚠️ 关键瓶颈
        ↓ (数据传输)
步骤5: 图像返回 Simulink      → 耗时: ~3ms
        ↓
总耗时:                        ~36-46ms (超出 20ms 目标)
```

**瓶颈说明**：

1. **步骤必须顺序执行**：下一步必须等待上一步完成
2. **GPU Readback 是最大瓶颈**：
   * 从 GPU 显存拷贝数据到 CPU 内存
   * 跨设备内存传输，无法加速
   * 数据量大时延迟显著增加

3. **CPU/GPU 大量空转时间**：
   * CPU 在等待 GPU 渲染时空闲
   * GPU 在等待 CPU 计算时空闲
   * 无法通过并行化释放潜能

**可视化时间线**：

```
时间轴:  0ms    5ms    7ms         23ms              43ms    46ms   50ms
        │      │      │           │                 │       │      │
CPU:    [计算]  │      │           │                 │    [空闲]   │
        ▓▓▓▓▓▓ │      │           │                 │              │
              └─[等待 GPU]─────────┘                 │              │
                                                     │              │
GPU:           │      [渲染]────────────────────────│              │
               │      ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ │              │
               │                                     [Readback]     │
                                                     ▓▓▓▓▓▓▓        │
传输:          [发送]                                       [接收]  │
               ▓▓▓                                          ▓▓▓▓   │

说明: ▓ 表示活跃工作，空白表示等待/空闲
```

### 4.3 异常观测：基础握手开销

#### 4.3.1 实验设计

**假设**：图像 Readback 是主要瓶颈
**验证方法**：注释掉所有 `Simulation 3D Camera Get` 模块

**预期结果**：性能应显著改善
**实际结果**：❌ 系统依然提示"无法以指定速率调速"

#### 4.3.2 初步判断

**结论**：
> 除了图像 Readback 的物理耗时外，**Simulink 与 UE5 之间的核心同步协议（Lock-step）**及 `Simulation 3D Scene Configuration` 的基础握手开销已占据了大部分时间预算。

**握手开销分解**（估算）：

```
总可用时间:           20ms  (50 Hz 采样周期)

基础开销:
├─ Lock-step 同步:    ~5ms   ⚠️
├─ 场景配置握手:      ~3ms   ⚠️
├─ 网络通信延迟:      ~2ms
└─ 序列化/反序列化:   ~2ms
                      ─────
小计:                 ~12ms  (已占用 60%)

剩余可用时间:         ~8ms

实际需求:
├─ Simulink 计算:     ~5ms
├─ UE5 渲染:          ~16ms  ❌ 超时
└─ 图像 Readback:     ~15ms  ❌ 超时

结果: 严重超时，无法实时运行
```

#### 4.3.3 深层原因分析

**Lock-step 同步机制**：

Simulink 与 UE5 采用严格的锁步同步：
1. Simulink 发送位姿数据
2. **等待 UE5 确认接收** ⏱️
3. UE5 更新场景
4. **等待渲染完成** ⏱️
5. 如果有相机，执行 Readback
6. **等待数据返回** ⏱️
7. 双方同步到下一时间步

每个"等待"都是强制的，无法跳过或异步化。

**为什么无法加速？**

| 尝试方案 | 理论可行性 | 实际可行性 | 原因 |
|---------|----------|----------|------|
| 提高 CPU 性能 | ✅ | ❌ | CPU 大部分时间在等待，不是瓶颈 |
| 提高 GPU 性能 | ✅ | ⚠️ | 可减少渲染时间，但无法消除 Readback |
| 降低分辨率 | ✅ | ✅ | 有效，但牺牲画质 |
| 异步通信 | ✅ | ❌ | 违背 Lock-step 同步要求 |
| 去掉图像回传 | ✅ | ⚠️ | 可行但失去感知能力 |

---

## 5. 解决方案探索 (Potential Solutions)

### 5.1 短期优化措施

1. **降低采样频率**：
   ```matlab
   Sample_Time = 0.05;  % 从 50Hz 降至 20Hz
   ```

2. **减少相机数量**：
   * 仅保留必要的前视相机
   * 移除调试用相机

3. **启用异步渲染**（如果支持）：
   * 允许 UE5 在后台渲染
   * 使用上一帧图像进行控制决策

4. **使用场景简化**：
   * 降低 UE5 场景复杂度
   * 减少动态光源和粒子效果

### 5.2 中长期架构改进

1. **双速率架构**：
   ```
   控制回路:   50 Hz  (高频，无视觉)
   视觉回路:   10 Hz  (低频，有延迟容忍)
   ```

2. **预测性控制**：
   * 使用船舶动力学模型预测未来状态
   * 减少对实时视觉反馈的依赖

3. **混合仿真模式**：
   * 关键阶段：UE5 高保真度仿真
   * 常规阶段：Simulink 快速仿真

4. **考虑替代方案**：
   * 使用 ROS2 + Gazebo 代替 UE5（可能更高效）
   * 使用离线渲染 + 录制回放

---

## 6. 经验总结 (Lessons Learned)

### 6.1 关键发现

1. **硬件不是瓶颈**：
   * CPU/GPU 占用率低不代表性能足够
   * 串行同步机制是真正的限制

2. **Lock-step 同步的代价**：
   * 保证确定性和可重复性
   * 但牺牲了实时性能

3. **图像回传是双重瓶颈**：
   * 渲染时间本身较长
   * GPU-to-CPU 数据传输无法优化

### 6.2 最佳实践

✅ **推荐做法**：
* 使用定步长求解器
* 统一所有模块的采样时间
* 尽可能降低相机分辨率
* 减少相机数量到最少
* 简化 UE5 场景复杂度

❌ **避免的陷阱**：
* 盲目追求高分辨率图像
* 使用过高的仿真频率 (>50Hz)
* 在 UE5 中使用过多实时光照
* 期望通过硬件升级解决同步问题

### 6.3 性能评估指标

| 指标 | 纯 Simulink | Simulink+UE5 | 目标 |
|------|------------|--------------|------|
| 实时性 | 1:1 完美实时 | 0.3:1 ~ 0.5:1 | 1:1 |
| CPU 占用 | 5% | 10% | <30% |
| GPU 占用 | 0% | 26% | <50% |
| 调速警告 | 无 | 频繁 | 无 |

---

## 7. 后续计划 (Future Work)

### 7.1 待验证的优化方案

- [ ] 测试不同采样频率组合 (20Hz, 10Hz, 5Hz)
- [ ] 评估去除图像回传后的性能提升
- [ ] 探索 UE5 Pixel Streaming 方案
- [ ] 研究 MATLAB ROS2 工具箱与 UE5 的集成

### 7.2 长期研究方向

- [ ] 开发自定义 UE5 插件以优化数据传输
- [ ] 研究异步仿真框架（放松 Lock-step 约束）
- [ ] 评估云端仿真方案的可行性

---

## 8. 关联资源 (References)

### 8.1 相关文件

* `DevLogs/04_Simulation/UE5_Simulink_Interface.md` - UE5 与 Simulink 接口文档
* `docs/coordinate_system_conversion.md` - 坐标系转换说明

### 8.2 相关讨论

* Issue #XX - Simulink UE5 实时性能问题
* PR #YY - 优化 Simulation 3D 配置

### 8.3 参考文档

* [MathWorks - Simulation 3D Blocks](https://www.mathworks.com/help/vdynblks/ug/simulation-3d-blocks.html)
* [Unreal Engine - Performance Guidelines](https://docs.unrealengine.com/5.0/en-US/performance-guidelines-for-unreal-engine/)
* [项目坐标系转换文档](../../docs/coordinate_system_conversion.md)

---

**完成日期**: 2025-12-21
**审核状态**: 待审核
