# 船舶差速推进轨迹异常问题分析 (Ship Differential Thrust Trajectory Issue)

**Tags:** `simulation`, `simulink`, `ship-dynamics`, `yaw-damping`, `trajectory`, `propeller`, `debugging`

**日期**: 2025-12-18
**状态**: 已解决 / 分析完成
**严重程度**: 🔴 高 - 影响基本转向功能


---

## 1. 问题描述 (Problem Statement)

### 1.1 现象

在 Simulink-UE5 联合仿真中，设置左右螺旋桨差速推进时，期望船舶能够画出圆形轨迹，但实际表现为**几乎原地旋转**。

**具体表现**:
- ✅ 等转速（左120 = 右120）时：船笔直正常前行
- ❌ 差速推进（左120 < 右140+）时：船在原地（或几乎原地）旋转
- ❌ 无法形成预期的圆弧轨迹

### 1.2 预期行为 vs 实际行为

```
预期轨迹:          实际轨迹:
    ⟲                  ⟳
  ╱   ╲               ┌─┐
 │     │              │ │  (原地打转)
  ╲   ╱               └─┘
    ⟳
(大圆弧轨迹,
回转半径200-500m)        (轨迹半径≈22m)
```

**物理直觉**:
- 差速越大，理论上转弯半径应该变小（但仍是"转弯"）
- 不应该退化为"原地旋转"

---

## 2. 根本原因分析 (Root Cause Analysis)

### 2.1 核心问题定位

经过深入分析 Simulink 船体模型，问题根源锁定在 **偏航阻尼力矩 (Yaw Damping Moment)** 计算模块：

```
Ndamp = -Nr · r
```

其中偏航阻尼系数 Nr 的计算公式为：

```
Nr = (Izz / T_yaw) · (1 + 10|u|)
```

**问题点**:
1. **速度相关放大因子** `(1 + 10|u|)` 导致高速时偏航阻尼急剧增大
2. **T_yaw 参数**可能选取不当（过小会导致阻尼过强）
3. **惯性矩 Izz** 可能因 payload 位置通过平行轴定理被放大

### 2.2 物理机理解释

#### 为什么会"原地转"？

差速推进时，系统力矩平衡关系：

```
总偏航力矩 = 推进器力矩 - 阻尼力矩
Mz_total = Mz_thrust - Ndamp
         = (TR - TL)·y_prop - Nr·r
```

当 **Nr 过大**时：
- 偏航角速度 r 一旦上升
- 阻尼力矩 Ndamp = Nr·r 急剧增大
- 抵消了推进器产生的转向力矩
- 同时由于耦合效应，**surge 方向的有效推力被"刹住"**
- 结果：转得动但走不动 → "原地转"

#### 速度放大因子的反直觉特性

公式中的 `(1 + 10|u|)` 意味着：

```
船速 u = 1 m/s  → 放大因子 = 11
船速 u = 2 m/s  → 放大因子 = 21
```

这相当于：**纵向速度越大，偏航越难发生**。

**与常识矛盾**:
- 常识：高速转弯更容易"甩尾"（稳定性下降）
- 模型：高速时偏航被强力抑制（像"电子稳定系统"）

**建模哲学冲突**:
- 这是一种"人为稳定化模型"，适用于演示/教学
- 不适用于真实物理仿真和控制验证

### 2.3 Simulink 模块分析

#### 阻尼计算模块结构

```
┌─────────────────────────────────────────────────────┐
│          Yaw Damping Coefficient (Nr)               │
├─────────────────────────────────────────────────────┤
│                                                      │
│  上支路（基础阻尼系数）:                              │
│  Inertials → Selector[6] → Izz                      │
│                 ↓                                    │
│             Divide (*/)  ← T_yaw                    │
│                 ↓                                    │
│              Gain(-1)                               │
│                 ↓                                    │
│           Nr0 = -Izz/T_yaw                          │
│                                                      │
│  下支路（速度放大因子）:                              │
│  Relative_Velocity → Selector[1] → u                │
│                 ↓                                    │
│              Abs |u|                                │
│                 ↓                                    │
│            Gain(10) → 10|u|                         │
│                 ↓                                    │
│            Add(++) ← 1                              │
│                 ↓                                    │
│         factor = 1 + 10|u|                          │
│                                                      │
│  合并:                                               │
│  Nr0 × factor = Nr                                  │
│                                                      │
│  最终阻尼矩:                                          │
│  Ndamp = Nr × r                                     │
└─────────────────────────────────────────────────────┘
```

**关键模块说明**:

1. **Selector 模块**:
   - 输入端口数: 2（都选 index=6）
   - 实际输出: 1×1 标量（通过 Data Inspector 验证）
   - 作用: 从 Inertials 向量中提取 Izz

2. **Product (Divide) 模块**:
   - 输入数目: `*/`
   - 运算: 逐元素除法 `u1 ./ u2`
   - 作用: 计算 Izz / T_yaw

3. **Add2 模块**:
   - 符号列表: `++`
   - 作用: 计算 `1 + 10|u|`

### 2.4 惯性矩阵构造机理

#### 惯性矩阵表达式

最终的 6DOF 惯性矩阵为：

```
M = M_RB^CO + M_A
```

其中：
- `M_RB^CO`: 刚体惯性矩阵（船体 + payload，在 CO 坐标系）
- `M_A`: 附加质量矩阵

刚体惯性矩阵的标准形式：

```
M_RB = ┌─────────────────────────────┐
       │  m·I₃      -m·S(r_g)        │
       │  m·S(r_g)   I_O             │
       └─────────────────────────────┘
```

#### 平行轴定理的影响

偏航惯量 Izz 通过平行轴定理计算：

```
I_O = I_G + m·S(r_g)ᵀS(r_g)

对于偏航分量:
Izz = Izz,G + m(x_g² + y_g²)
```

**关键点**:
- payload 位置 (x_p, y_p) 偏离 CO 越远
- Izz 按 **质量 × 距离²** 增长
- 直接放大 Nr = Izz / T_yaw
- 导致偏航阻尼进一步增强

---

## 3. 排查流程与验证方法 (Troubleshooting)

### 3.1 最快定位法：查看力/力矩分解

在 Simulink 中添加信号日志，记录以下 4 个量：

```matlab
% 差速工况下运行 5-10 秒
1. Thrust 输出的 X 分量 (Fx_thrust)
2. Thrust 输出的 N 分量 (Mz_thrust)
3. Sum of Forces 的 X 分量 (Fx_total)
4. Sum of Forces 的 N 分量 (Mz_total)
```

**诊断逻辑**:

| 症状 | 根本原因 | 对策 |
|------|---------|------|
| Fx_thrust ≈ 0，但 Mz_thrust 很大 | 推进器方向/通道/位置问题 | 检查推力映射、坐标系、lever arm |
| Fx_thrust 正常，但 Fx_total ≈ 0 | 阻尼/相对速度/限幅问题 | 检查 Hydrodynamics.Damping 参数 |
| 两者都不小，但 surge 起不来 | 质量/附加质量过大 | 检查 Inertials 和 M_A 量级 |

### 3.2 分步验证实验

#### 实验 1: 单桨测试

```
工况 1: 左桨=120, 右桨=0
工况 2: 左桨=0,   右桨=120
```

**预期**:
- 两种工况都应该**向前走**并偏航（方向相反）
- 如果某个桨"只转不走"或"往后推" → 推力方向定义错误

#### 实验 2: 小差速扫描

```
左桨固定 120, 右桨递增:
120 → 125 → 130 → 135 → 140 → ...
```

**观察**:
- 从"直行"到"转弯"的过渡是否平滑
- 差速增大时，转弯半径是否合理减小
- 还是突然"塌缩"成原地转

#### 实验 3: 去掉速度放大因子

**临时修改**:
```
Nr = Izz / T_yaw · (1 + 10|u|)  →  Nr = Izz / T_yaw
```

**判断**:
- ✅ 如果轨迹从"原地转"变为"能画圆" → 速度因子是罪魁祸首
- ❌ 如果几乎无变化 → 需要检查推进器/耦合项

---

## 4. 解决方案 (Solutions)

### 4.1 方案 1: 去掉速度相关放大因子（推荐）

**修改前**:
```
Nr = (Izz / T_yaw) · (1 + 10|u|)
```

**修改后**:
```
Nr = Izz / T_yaw
```

**理由**:
- 更符合真实船舶物理
- 高速时不会人为抑制偏航
- 适合控制算法验证

### 4.2 方案 2: 调整 T_yaw 参数

#### T_yaw 的物理意义

从简化偏航动力学：

```
Izz·ṙ = -Nr·r
ṙ = -(1/T_yaw)·r

解得: r(t) = r(0)·e^(-t/T_yaw)
```

**T_yaw 是偏航角速度的一阶衰减时间常数**。

#### 推荐取值

| 场景 | T_yaw | 特性 |
|------|-------|------|
| 真实灵敏船 | 5~15 s | 转弯自然，不易被压死 ✅ |
| 稳定平台船 | 2~5 s | 偏航被抑制，轨迹稳定 |
| 危险区域 | < 1 s | 偏航阻尼过大 ❌ |

**选择方法**（反向思考）:
> "如果船以某角速度在转，完全不给推进器，希望多久停下来？"

- 想 10 秒左右停 → T_yaw ≈ 3 s
- 想 20-30 秒慢慢停 → T_yaw ≈ 8-10 s

**推荐起始值**: `T_yaw = 8 s`（安全、不激进）

### 4.3 方案 3: 使用更物理的阻尼模型

**线性 + 二次阻尼**:
```
Ndamp = -Nr0·r - Nr2·|r|·r
```

其中：
- Nr0: 线性阻尼系数
- Nr2: 二次阻尼系数

**特点**:
- 阻尼随"转得多快"增强（而非"走得多快"）
- 符合流体力学特性

### 4.4 方案 4: 检查推进器配置

**必查参数**:

1. **推进器位置 (x, y, z)**:
   - 左右桨的 y 坐标符号是否正确
   - 单位是否一致（m vs cm）
   - lever arm 是否过大

2. **推力方向**:
   - 左右桨是否都沿 +X 方向
   - 有无镜像/坐标系定义不一致

3. **rpm → thrust 映射**:
   - 是否为平方律: T = K·n·|n|
   - 系数 K 是否合理
   - 有无限幅/饱和

4. **相对速度计算**:
   - Current speed/direction 坐标系是否正确
   - 是否导致 surge 阻尼异常大

---

## 5. 实施步骤 (Implementation)

### Step 1: 快速验证（10 分钟）

1. 打开 Simulink 模型的 Yaw 阻尼计算模块
2. 临时将 `(1 + 10|u|)` 改为 `1`
3. 运行差速工况（左120, 右140）
4. 观察轨迹是否改善

### Step 2: 参数调整（20 分钟）

1. 设置 `T_yaw = 8 s`
2. 检查 Inertials 输出的 Izz 值
3. 验证 `Nr = Izz / T_yaw` 的量级是否合理

**量级检查公式**:
```
对于典型小型 USV (长度 2-3m, 质量 50-100kg):
Izz ≈ 20-100 kg·m²
T_yaw = 5-10 s
→ Nr ≈ 2-20 N·m·s
```

### Step 3: 完整验证（1 小时）

1. 运行单桨测试
2. 运行小差速扫描
3. 记录轨迹数据并绘图
4. 验证转弯半径是否符合预期

### Step 4: 推进器检查（如果问题仍存在）

```matlab
% 在 Thrust 模块输出处添加 Scope
% 记录两组工况:
% 工况 A: L=120, R=120
% 工况 B: L=120, R=140

% 对比输出向量的:
Fx_A vs Fx_B  % 前向推力
Mz_A vs Mz_B  % 偏航力矩

% 判断:
% 如果 Fx_B << Fx_A → 推进器映射有问题
% 如果 Mz_B / Mz_A 不合理 → lever arm 或方向有问题
```

---

## 6. 验证结果 (Verification)

### 6.1 成功指标

- ✅ 差速推进能够形成圆弧轨迹
- ✅ 转弯半径随差速增大而减小（但不会突变为 0）
- ✅ 高速时仍能转弯（不被过度抑制）
- ✅ 单桨测试时两侧推进方向一致

### 6.2 定量验证

**理论转弯半径估算**:

```
R = V / ω
  ≈ V / (Mz_thrust / Izz_eff)

其中:
V: 前向速度
ω: 偏航角速度
Mz_thrust: 推进器偏航力矩 ≈ (T_R - T_L)·y_prop
Izz_eff: 有效偏航惯量
```

**验证方法**:
1. 仿真中记录稳态时的 V 和 ω
2. 计算实际转弯半径 R_actual = V / ω
3. 与理论值 R_theory 对比

**合理范围**:
```
对于小型 USV (长度 2-3m):
轻微差速 (ΔT = 20%) → R ≈ 10-20m
中等差速 (ΔT = 50%) → R ≈ 5-10m
大差速 (ΔT = 100%) → R ≈ 2-5m

❌ 不应该: R < 1m（接近原地转）
```

---

## 7. 经验总结 (Lessons Learned)

### 7.1 核心教训

1. **不要让"希望船稳定"的愿望通过隐藏参数实现**
   - 稳定性应来自合理的惯量、推进器布局、控制器
   - 而不是 `Nr ∝ |u|` 这种"隐形电子稳定系统"

2. **区分"能跑的模型"和"可信的模型"**
   - 演示级模型: 人为稳定化，好看但不真实
   - 仿真级模型: 保留真实的不稳定性

3. **速度相关阻尼的物理直觉**
   - 阻尼应该随"转得多快" (r) 增强
   - 而不是随"走得多快" (u) 增强

4. **平行轴定理的隐藏影响**
   - Payload 位置会通过 `m·r²` 显著放大惯量
   - 必须考虑在 T_yaw 的选取中

### 7.2 建模哲学

**A 类模型（自然动力学）**:
- 高速 → 稳定性下降
- 小扰动 → 大响应
- 适用场景: 真实物理仿真、控制验证

**B 类模型（人为稳定化）**:
- 高速 → 人为增强阻尼
- 保证数值稳定、轨迹好看
- 适用场景: 教学演示、早期调试

**本问题**: 错误地使用了 B 类模型进行 A 类任务

### 7.3 Simulink 建模最佳实践

1. **每一根线都要能写成公式**
   - 删除冗余端口、模板遗留
   - Selector 不用多个端口除非有明确理由

2. **用 Data Inspector 验证信号维度**
   - 不要假设"应该是标量"
   - 直接看日志确认

3. **分步验证、不猜参数**
   - 先看力/力矩分解，再调参
   - 用实验（单桨、小差速）锁定问题

### 7.4 可复用的检查清单

**Yaw 动力学问题通用排查表**:

| 检查项 | 具体内容 | 工具 |
|--------|---------|------|
| □ 推进器方向 | 左右桨是否都沿 +X | 单桨测试 |
| □ 推进器位置 | lever arm y 的符号和单位 | 参数文件 |
| □ 阻尼系数 | Nr 的量级是否合理 | Data Inspector |
| □ 速度耦合 | 是否有不合理的速度放大项 | 公式审查 |
| □ 惯性矩阵 | Izz 是否被 payload 过度放大 | 平行轴计算 |
| □ T_yaw | 是否在 5-15s 合理区间 | 参数调整实验 |

---

## 8. 关联资源 (References)

### 8.1 相关文件

- `DevLogs/04_Simulation/UE5_Simulink_Interface.md` - 仿真接口配置
- Simulink 模型: `Ship_6DOF_Model.slx`
- 阻尼计算模块: `Hydrodynamics/Damping`
- 惯性矩阵模块: `Input_Processing/Inertials`

### 8.2 理论参考

- **Fossen, T. I.** (2011). *Handbook of Marine Craft Hydrodynamics and Motion Control*. Wiley.
  - 第 3 章: 刚体动力学与惯性矩阵
  - 第 6 章: 阻尼模型

- **平行轴定理** (Parallel Axis Theorem):
  ```
  I_O = I_G + m·d²
  ```

### 8.3 相关技术讨论

- 问题发现日期: 2025-12-18
- 分析讨论记录: 见本文档完整技术对话

### 8.4 相关 Commit

```bash
# 待修复后添加
# git commit -m "fix: adjust yaw damping coefficient to prevent on-spot rotation"
# git commit -m "refactor: remove unrealistic velocity-dependent yaw damping factor"
```

---

## 9. 下一步行动 (Next Steps)

### 9.1 立即行动

- [ ] 移除速度放大因子 `(1 + 10|u|)`
- [ ] 设置 `T_yaw = 8 s` 作为起始值
- [ ] 运行验证实验（单桨 + 差速扫描）
- [ ] 记录修改前后的轨迹对比

### 9.2 后续优化

- [ ] 实现线性 + 二次阻尼模型
- [ ] 根据实船数据校准 Nr0 和 Nr2
- [ ] 添加侧滑耦合项（如需要）
- [ ] 考虑将阻尼放到控制器层

### 9.3 文档完善

- [ ] 补充实际修改后的验证数据
- [ ] 绘制修改前后轨迹对比图
- [ ] 记录最终参数配置
- [ ] 更新 Simulink 模型文档

---

**记录人**: Claude (AI Assistant) & CXZ
**技术审查**: 待审核
**完成日期**: 2025-12-18
**文档版本**: v1.0

---

## 附录 A: 关键公式汇总

### A.1 偏航阻尼力矩

```
Ndamp = -Nr·r

其中:
Nr: 偏航阻尼系数
r: 偏航角速度
```

### A.2 偏航阻尼系数（问题版本）

```
Nr = (Izz / T_yaw) · (1 + 10|u|)
      └────┬────┘   └─────┬─────┘
      基础阻尼      速度放大因子
                    (反直觉!)
```

### A.3 偏航阻尼系数（推荐版本）

```
Nr = Izz / T_yaw

或更完整的形式:
Ndamp = -Nr0·r - Nr2·|r|·r
         └─┬─┘   └────┬────┘
        线性项    二次项
```

### A.4 平行轴定理

```
Izz = Izz,G + m(x_g² + y_g²)
      └──┬──┘   └──────┬──────┘
     质心惯量    平移修正项
```

### A.5 一阶衰减动力学

```
ṙ = -(1/T_yaw)·r

解得:
r(t) = r(0)·e^(-t/T_yaw)

在 t = T_yaw 时:
r(T_yaw) = r(0)·e^(-1) ≈ 0.368·r(0)
```

### A.6 转弯半径估算

```
R = V / ω
  ≈ V / (Mz_thrust / Izz_eff)
  ≈ V·Izz_eff / [(T_R - T_L)·y_prop]
```

---

## 附录 B: Simulink 模块配置详解

### B.1 Selector 模块

```yaml
模块名称: Selector (用于提取 Izz)
配置:
  输入端口数: 1 (推荐) 或 2 (如果需要对比两个信号)
  索引方式: 索引向量(对话框)
  索引: 6
  输出: 1×1 标量 (Izz)

注意事项:
  - 多个端口选同一索引会导致维度混淆
  - 用 Data Inspector 验证输出是标量
  - 确认 index=6 确实对应 Izz
```

### B.2 Product (Divide) 模块

```yaml
模块名称: Product (用于计算 Izz/T_yaw)
配置:
  输入数目: "*/"  ← 关键! 第一个乘,第二个除
  乘法: 按元素 (.*)
  运算: u1 ./ u2

等价于:
  output = Izz / T_yaw

常见错误:
  - 输入数目写成 "**" → 变成乘法
  - 分子分母接反 → T_yaw / Izz
```

### B.3 Add 模块（速度因子）

```yaml
模块名称: Add2 (构造 1 + 10|u|)
配置:
  符号列表: "++"
  输入 1: 常数 1
  输入 2: 10·|u|
  输出: 1 + 10|u|

建议修改:
  - 删除此模块
  - 或将输入 2 改为 0 (等效于去掉速度因子)
```

---

## 附录 C: 典型参数参考值

### C.1 小型 USV (2-3m 长度)

```yaml
船体参数:
  长度: 2.5 m
  宽度: 1.0 m
  质量: 80 kg

惯性参数:
  Izz: 30-60 kg·m²
  (含 payload 可能达到 80-100 kg·m²)

推进参数:
  推进器间距 (2·y_prop): 0.8 m
  单推最大推力: 50 N

阻尼参数:
  T_yaw: 8 s (推荐起始值)
  Nr: Izz / T_yaw ≈ 4-8 N·m·s
```

### C.2 中型 USV (4-5m 长度)

```yaml
船体参数:
  长度: 4.5 m
  宽度: 1.5 m
  质量: 250 kg

惯性参数:
  Izz: 150-300 kg·m²

推进参数:
  推进器间距 (2·y_prop): 1.2 m
  单推最大推力: 150 N

阻尼参数:
  T_yaw: 10 s
  Nr: 15-30 N·m·s
```

---

**文档状态**: ✅ 完成
**最后更新**: 2025-12-18



