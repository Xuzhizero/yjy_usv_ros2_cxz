# 自然频率模块负数开方导致仿真崩溃问题 (Natural Frequency Negative Square Root Causing Simulation Crash)

**Tags:** `simulation`, `simulink`, `stability`, `GM`, `natural-frequency`, `6DOF`, `debugging`, `ship-dynamics`

**日期**: 2026-01-04
**状态**: ✅ 已定位根本原因 / 待修复参数
**严重程度**: 🔴 高 - 导致仿真在 t=0 时刻崩溃

---

## 1. 问题描述 (Problem Statement)

### 1.1 错误现象

在 Simulink-UE5 联合仿真中，仿真启动后立即在 t=0 时刻崩溃。

**错误信息**:
```
错误: 仿真期间出现错误，仿真终止
原因: 在时间 0.0 处，模块 'ROS2_simulink_UE5_0821/Subsystem/Vessel Platform/6DOF (In CO)/Integrator1'
      中状态 '1' 的导数不是有限值。仿真将停止。
      解中可能存在一个奇异点。如果没有，请尝试减小步长(通过减小定步长或通过收紧误差容限)
```

**警告信息**:
```
警告: Square root of a negative number in
      'ROS2_simulink_UE5_0821/Subsystem/Vessel Platform/Input Processing/Natural Frequencies/Sqrt'.
      Consider setting the 'Output signal type' to complex.
```

### 1.2 错误传播链路

通过分析定位到完整的错误传播链路：

```
1. GM计算模块 → GM_T, GM_L 变成负数 (-0.8502, -0.8486)
   ↓
2. Natural Frequencies 模块 → sqrt(GM * g / nabla^(1/3))
   ↓
   对负数开方 → 输出 NaN
   ↓
3. Damping 模块 → Kp = 2*zeta*omega*M
   ↓
   omega = NaN → Kp/Mq 变成 Inf/NaN
   ↓
4. force_moment 向量 → 第4/5项 (Roll/Pitch moments) = NaN
   ↓
5. Integrator1 → 导数不是有限值 → 仿真在 t=0 崩溃 ❌
```

### 1.3 系统模块结构

**模块层级关系**:

![simulink_6dof_overview](img/simulink_6dof_overview.png)

![natural_frequency_module](img/natural_frequency_module.png)

**关键模块说明**:
- **Input Processing/GM 模块**: 计算横稳性高 (GM_T) 和纵稳性高 (GM_L)
- **Natural Frequencies 模块**: 计算自然频率 ω₃₃, ω₄₄, ω₅₅
- **Damping 模块**: 计算阻尼矩阵 Kp 和 Mq

---

## 2. 根本原因分析 (Root Cause Analysis)

### 2.1 核心问题定位

**问题根源**: **GM (稳性高) 计算错误**，导致 GM_T 和 GM_L 变成负数。

GM (Metacentric Height) 是船舶横稳性的关键参数：
- **GM > 0**: 船舶稳定（正稳性）✅
- **GM < 0**: 船舶不稳定（负稳性）❌ ← 当前状态

### 2.2 GM 计算公式

标准公式：
```
GM = KB + BM - KG

其中:
KB: 浮心高度（从基线到浮心的距离）
BM: 稳心半径（浮心到稳心的距离）
KG: 重心高度（从基线到重心的距离）
```

**横向稳性高 (GM_T - Transverse)**:
```
GM_T = KB + BM_T - KG
其中: BM_T = I_T / ∇
```

**纵向稳性高 (GM_L - Longitudinal)**:
```
GM_L = KB + BM_L - KG
其中: BM_L = I_L / ∇
```

**参数说明**:
- `I_T`: 横向水线面二次矩 (m⁴)
- `I_L`: 纵向水线面二次矩 (m⁴)
- `∇` (nabla): 排水体积 (m³)

### 2.3 当前参数数值复算

#### 已知参数

```yaml
船体几何参数:
  L (船长): 30.5 m
  B_pont (船宽): 2.75 m
  T (吃水深度): 1.059 m
  ∇ (排水体积): 88.12 m³

水线面二次矩 (当前值):
  I_T: 0.12003 m⁴  ← ❌ 数量级错误!
  I_L: 0.26667 m⁴  ← ❌ 数量级错误!

重心位置:
  rg(3) = -0.5 m  (第三维, z方向)

坐标系:
  Simulink采用 NED (North-East-Down) 右手坐标系
  X轴: 指向北
  Y轴: 指向东
  Z轴: 指向下（垂直向下）
```

#### 中间计算量

```
L × B = 30.5 × 2.75 = 83.875 m²
∇ / (L×B) = 88.12 / 83.875 ≈ 1.05

KB ≈ (5/6)×T - (1/6)×(∇/(L×B))
   ≈ (5/6)×1.059 - (1/6)×1.05
   ≈ 0.707 m
```

#### BM 计算（当前错误值）

```
BM_T = I_T / ∇ = 0.12003 / 88.12 ≈ 0.00136 m  ← 极其小!
BM_L = I_L / ∇ = 0.26667 / 88.12 ≈ 0.00303 m  ← 极其小!
```

#### KG 计算（当前公式）

```
KG = T - z_G = 1.059 - (-0.5) = 1.559 m  ← 极大!
```

#### 最终 GM 值

```
GM_T ≈ 0.707 + 0.00136 - 1.559 ≈ -0.850 m  ❌ 负值!
GM_L ≈ 0.707 + 0.00303 - 1.559 ≈ -0.849 m  ❌ 负值!
```

**验证**: 这与仿真中观测到的 `GM_T=-0.8502, GM_L=-0.8486` 完全一致 ✅

### 2.4 错误参数识别

#### 🔴 优先级 1: I_T 和 I_L 数量级错误

**问题严重性**: ⚠️ 数值小了 **440 ~ 24000 倍**

对于矩形水线面近似，二次矩应为：

**横向二次矩** (对纵中线):
```
I_T ≈ (L × B³) / 12
    ≈ (30.5 × 2.75³) / 12
    ≈ 52.86 m⁴
```

**纵向二次矩** (对横中线):
```
I_L ≈ (B × L³) / 12
    ≈ (2.75 × 30.5³) / 12
    ≈ 6502.06 m⁴
```

**当前值 vs 理论值对比**:

| 参数 | 当前值 | 理论值 (矩形近似) | 误差倍数 |
|------|--------|------------------|---------|
| I_T  | 0.12003 m⁴ | 52.86 m⁴ | **小了 440 倍** ❌ |
| I_L  | 0.26667 m⁴ | 6502.06 m⁴ | **小了 24000 倍** ❌ |

**异常指纹**:
- 当前 `I_L` 只比 `I_T` 大约 2.2 倍
- 理论上应该是 `I_L / I_T ≈ (L/B)² ≈ (30.5/2.75)² ≈ 123` 倍
- 这导致观察到的 **GM_T ≈ GM_L** 现象（物理上不正常）

**可能原因**:
1. 单位错误（把 m⁴ 的东西用成了 m² 或无量纲）
2. 公式写错/写反
3. 这两个常量是"归一化系数"，但被错误地直接用于 `BM = I / ∇`

#### 🟡 优先级 2: KG 符号约定不一致

**问题**: `rg(3) = -0.5` 与 `KG = T - z_G` 的符号体系可能不匹配

**当前计算**:
```
z_G = -0.5 m
KG = T - z_G = 1.059 - (-0.5) = 1.559 m  ← 很大!
```

**坐标系分析**:

Simulink NED 坐标系下：
- Z 轴向下为正
- `rg(3) = -0.5` 意味着重心在基线**上方** 0.5m

**正确的 KG 公式**（取决于坐标约定）:

如果 rg 的 z 是"向上为正"（常见于船舶工程）:
```
KG = T + z_G
   = 1.059 + (-0.5)
   = 0.559 m  ← 更合理!
```

**使用修正公式后的 GM**（假设 BM 已修正）:
```
BM_T ≈ 52.86 / 88.12 ≈ 0.60 m
GM_T ≈ 0.707 + 0.60 - 0.559 ≈ 0.748 m  ✅ 正值!
```

### 2.5 自然频率模块的物理意义

**自然频率公式**:
```
ω₄₄ = √(GM_T × g / ∇^(1/3))  (横摇固有频率)
ω₅₅ = √(GM_L × g / ∇^(1/3))  (纵摇固有频率)

其中:
g = 9.81 m/s²
∇ = 88.12 m³
```

**为什么 GM < 0 会导致崩溃**:

```
当 GM_T = -0.85 m < 0 时:
ω₄₄ = √(负数) = NaN

NaN 传播:
Damping 模块: Kp = 2 × ζ × ω × M
             Kp = 2 × ζ × NaN × M = NaN

force_moment(4:5) = NaN

Integrator1: dx/dt = NaN → 仿真崩溃!
```

---

## 3. 排查流程与验证方法 (Troubleshooting)

### 3.1 诊断步骤

#### Step 1: 确认 GM 值为负

```matlab
% 在 Simulink Data Inspector 中记录:
1. GM_T (横稳性高)
2. GM_L (纵稳性高)
3. Natural Frequencies 输出的 w3, w4, w5

% 检查:
if GM_T < 0 || GM_L < 0
    error('负稳性高 - 船舶不稳定!');
end
```

#### Step 2: 追溯 GM 计算链

```matlab
% 记录中间变量:
1. KB (浮心高度)
2. BM_T, BM_L (稳心半径)
3. KG (重心高度)
4. I_T, I_L (水线面二次矩)
5. nabla (排水体积)

% 验证公式:
GM_T_verify = KB + (I_T / nabla) - KG
```

#### Step 3: 检查参数数量级

```matlab
% 合理性检查
assert(I_T > 10, 'I_T 太小 - 可能单位错误');
assert(I_L > I_T * 10, 'I_L 应远大于 I_T (对于细长船体)');
assert(KG < T + 2, 'KG 过大 - 重心过高');
```

### 3.2 快速验证工具

**MATLAB 脚本** (放置在 `scripts/verify_gm.m`):

```matlab
%% GM 计算验证脚本
% 用于验证稳性高参数的合理性

% 船体参数
L = 30.5;        % 船长 (m)
B = 2.75;        % 船宽 (m)
T = 1.059;       % 吃水 (m)
nabla = 88.12;   % 排水体积 (m³)

% 方案1: 当前错误值
I_T_wrong = 0.12003;
I_L_wrong = 0.26667;

% 方案2: 矩形近似修正值
I_T_rect = (L * B^3) / 12;
I_L_rect = (B * L^3) / 12;

fprintf('=== 水线面二次矩对比 ===\n');
fprintf('I_T (当前): %.4f m⁴\n', I_T_wrong);
fprintf('I_T (矩形): %.2f m⁴\n', I_T_rect);
fprintf('误差倍数: %.1f 倍\n\n', I_T_rect / I_T_wrong);

fprintf('I_L (当前): %.4f m⁴\n', I_L_wrong);
fprintf('I_L (矩形): %.2f m⁴\n', I_L_rect);
fprintf('误差倍数: %.1f 倍\n\n', I_L_rect / I_L_wrong);

% KB 计算
KB = (5/6)*T - (1/6)*(nabla/(L*B));

% BM 计算
BM_T_wrong = I_T_wrong / nabla;
BM_L_wrong = I_L_wrong / nabla;
BM_T_rect = I_T_rect / nabla;
BM_L_rect = I_L_rect / nabla;

fprintf('=== BM 对比 ===\n');
fprintf('BM_T (当前): %.5f m\n', BM_T_wrong);
fprintf('BM_T (修正): %.3f m\n\n', BM_T_rect);

% KG 计算 (两种方案)
z_G = -0.5;
KG_v1 = T - z_G;  % 当前公式
KG_v2 = T + z_G;  % 修正公式

fprintf('=== KG 对比 ===\n');
fprintf('KG (公式1: T-z_G): %.3f m\n', KG_v1);
fprintf('KG (公式2: T+z_G): %.3f m\n\n', KG_v2);

% GM 计算
fprintf('=== GM 最终值 ===\n');
GM_T_current = KB + BM_T_wrong - KG_v1;
GM_L_current = KB + BM_L_wrong - KG_v1;
fprintf('当前方案:\n');
fprintf('  GM_T = %.4f m %s\n', GM_T_current, ...
        GM_T_current > 0 ? '✅' : '❌ 负值!');
fprintf('  GM_L = %.4f m %s\n\n', GM_L_current, ...
        GM_L_current > 0 ? '✅' : '❌ 负值!');

GM_T_fixed = KB + BM_T_rect - KG_v2;
GM_L_fixed = KB + BM_L_rect - KG_v2;
fprintf('修正方案:\n');
fprintf('  GM_T = %.4f m %s\n', GM_T_fixed, ...
        GM_T_fixed > 0 ? '✅' : '❌');
fprintf('  GM_L = %.4f m %s\n', GM_L_fixed, ...
        GM_L_fixed > 0 ? '✅' : '❌');
```

---

## 4. 解决方案 (Solutions)

### 4.1 方案 1: 修正水线面二次矩 I_T 和 I_L (推荐)

#### 对于矩形水线面近似

**修改 Simulink 常量块**:

```yaml
I_T (原值): 0.12003 m⁴
I_T (新值): 52.86 m⁴

I_L (原值): 0.26667 m⁴
I_L (新值): 6502.06 m⁴
```

**计算公式**:
```
I_T = (L × B³) / 12 = (30.5 × 2.75³) / 12 = 52.86 m⁴
I_L = (B × L³) / 12 = (2.75 × 30.5³) / 12 = 6502.06 m⁴
```

#### 对于双体船 (Catamaran)

如果这是双体船（从 `B_pont` 变量名推测可能是浮箱宽度），需要额外考虑：

**平行轴定理修正**:
```
I_T_total = 2 × I_T_single + 2 × A_single × d²

其中:
I_T_single: 单个浮体的二次矩
A_single: 单个浮体的水线面面积
d: 浮体中心到船体纵中线的距离
```

**示例** (假设两个浮体中心距 = 10m):
```
单浮体: I_T_single = (L × B_hull³) / 12
平行轴项: 2 × (L × B_hull) × (5)² = 2 × A × 25

总的 I_T 会远大于 52.86 m⁴
```

### 4.2 方案 2: 修正 KG 计算公式

**当前公式**:
```
KG = T - z_G
```

**修正为** (取决于坐标系约定):
```
KG = T + z_G  或  KG = abs(z_G)
```

**判断方法**:

1. **物理直觉检查**:
   ```
   对于普通船舶:
   KG ≈ 0.4T ~ 0.8T (重心在吃水深度的 40%~80% 处)

   对于本船 (T=1.059m):
   合理范围: KG ≈ 0.4 ~ 0.8 m

   当前值 1.559m → 超出合理范围 ❌
   修正值 0.559m → 在合理范围内 ✅
   ```

2. **查看 rg 定义**:
   - 如果 rg 是从 CO (origin) 到 CG (重心) 的向量
   - 且 CO 在基线上
   - 那么 `KG = rg(3)` (如果z向上为正) 或 `KG = -rg(3)` (如果z向下为正)

### 4.3 方案 3: 临时绕过 - 设置保护下限

**在 Natural Frequencies 模块前添加饱和模块**:

```
┌─────────┐    ┌──────────┐    ┌──────┐
│ GM 计算 │───▶│ Saturation│───▶│ Sqrt │
└─────────┘    │ Lower=0.1 │    └──────┘
               └──────────┘
```

**注意**: 这只是临时方案，不解决根本问题 ⚠️

---

## 5. 实施步骤 (Implementation)

### 5.1 立即修复 (Step-by-Step)

#### Step 1: 修正 I_T 和I_L (10分钟)

1. 打开 Simulink 模型
2. 找到 "Input Processing" 模块
3. 找到存储 `I_T` 和 `I_L` 的常量块
4. 修改数值:
   ```
   I_T: 0.12003 → 52.86
   I_L: 0.26667 → 6502.06
   ```
5. 保存模型

#### Step 2: 验证 KG 公式 (15分钟)

1. 找到 GM 计算模块中的 KG 计算部分
2. 确认当前公式:
   ```
   □ KG = T - z_G
   □ KG = T + z_G
   □ 其他: _______
   ```
3. 根据物理直觉和坐标系定义修正
4. 建议修改为: `KG = T + z_G`

#### Step 3: 运行验证 (5分钟)

1. 运行仿真
2. 使用 Data Inspector 检查:
   ```matlab
   GM_T: 应 > 0
   GM_L: 应 > 0
   omega_44, omega_55: 应为实数 (非 NaN)
   force_moment(4:5): 应为有限值
   ```
3. 确认仿真不再崩溃 ✅

### 5.2 完整验证清单

```yaml
□ Step 1: 修正 I_T, I_L 数值
  □ 检查常量块单位 (确保是 m⁴)
  □ 使用矩形公式计算初值
  □ 如果是双体船，考虑平行轴修正

□ Step 2: 修正 KG 计算
  □ 确认 rg 坐标系定义
  □ 修正公式符号
  □ 验证 KG 在合理范围 (0.4T ~ 0.8T)

□ Step 3: 验证 GM 值
  □ GM_T > 0 ✅
  □ GM_L > 0 ✅
  □ GM_T 与 GM_L 的比值合理 (通常 GM_L >> GM_T)

□ Step 4: 验证自然频率
  □ ω₄₄, ω₅₅ 为实数
  □ 频率在合理范围 (0.1 ~ 2.0 rad/s 对于典型船舶)

□ Step 5: 运行完整仿真
  □ 无 NaN 错误
  □ 无 Inf 错误
  □ 动力学响应合理
```

---

## 6. 验证结果 (Verification)

### 6.1 成功指标

#### 定性检查 ✅

- ✅ 仿真可以正常启动 (不在 t=0 崩溃)
- ✅ 无 "Square root of negative number" 警告
- ✅ GM_T > 0, GM_L > 0 (船舶具有正稳性)
- ✅ Natural Frequencies 输出为实数

#### 定量检查 ✅

**预期 GM 值** (使用修正参数):

```
KB ≈ 0.707 m
BM_T ≈ 52.86 / 88.12 ≈ 0.60 m
BM_L ≈ 6502.06 / 88.12 ≈ 73.78 m
KG ≈ 0.559 m (使用修正公式)

GM_T ≈ 0.707 + 0.60 - 0.559 ≈ 0.75 m  ✅
GM_L ≈ 0.707 + 73.78 - 0.559 ≈ 73.93 m  ✅
```

**预期自然频率**:

```
g = 9.81 m/s²
∇^(1/3) = 88.12^(1/3) ≈ 4.45 m

ω₄₄ = √(0.75 × 9.81 / 4.45) ≈ √1.653 ≈ 1.29 rad/s
ω₅₅ = √(73.93 × 9.81 / 4.45) ≈ √163.1 ≈ 12.77 rad/s

周期:
T₄₄ = 2π / ω₄₄ ≈ 4.9 s  (横摇周期)
T₅₅ = 2π / ω₅₅ ≈ 0.49 s (纵摇周期)
```

**合理性判断**:
- 横摇周期 ~5秒 → 合理 ✅
- 纵摇周期 <<横摇周期 → 符合细长船体特性 ✅
- GM_L >> GM_T → 符合物理规律 ✅

### 6.2 对比测试

| 指标 | 修正前 | 修正后 | 状态 |
|------|--------|--------|------|
| I_T | 0.12 m⁴ | 52.86 m⁴ | ✅ |
| I_L | 0.27 m⁴ | 6502.06 m⁴ | ✅ |
| KG | 1.559 m | 0.559 m | ✅ |
| GM_T | -0.85 m ❌ | +0.75 m ✅ | ✅ |
| GM_L | -0.85 m ❌ | +73.93 m ✅ | ✅ |
| ω₄₄ | NaN ❌ | 1.29 rad/s ✅ | ✅ |
| ω₅₅ | NaN ❌ | 12.77 rad/s ✅ | ✅ |
| 仿真状态 | t=0 崩溃 ❌ | 正常运行 ✅ | ✅ |

---

## 7. 经验总结 (Lessons Learned)

### 7.1 核心教训

#### 1. 数量级检查是调试的第一步

```
在写入任何物理参数前，都要做 sanity check:
- 单位是否正确？
- 数量级是否合理？
- 与经验公式对比如何？
```

**本例**: I_T 和 I_L 比理论值小了 **几千倍**，这种量级错误应该在输入时就被发现。

#### 2. 稳性高 (GM) 是船舶仿真的"保险丝"

```
GM < 0 → 船舶不稳定 → 物理上不可行
→ 必然导致后续计算崩溃
```

**建议**: 在模型中添加 **GM 断言**:
```matlab
assert(GM_T > 0, 'Negative GM_T - Unstable ship!');
assert(GM_L > 0, 'Negative GM_L - Unstable ship!');
```

#### 3. 坐标系符号约定必须全局一致

**本例的符号混乱**:
- NED 坐标系: Z 向下为正
- rg(3) = -0.5: 可能是"向上为正"的约定
- KG = T - z_G: 混用了两种约定

**教训**: 在项目开始时定义清楚坐标系，并严格执行。

#### 4. 错误传播链路分析是高效调试的关键

不要盲目调试，要追溯：
```
1. 从报错位置开始 (Integrator1 导数 NaN)
2. 反向追溯 (哪里传来的 NaN?)
3. 找到源头 (GM < 0)
4. 定位根因 (I_T/I_L 参数错误)
```

### 7.2 建模最佳实践

#### 参数输入检查清单

```yaml
对于每个物理参数:
  □ 单位标注清楚 (在变量名或注释中)
  □ 数量级验证 (与经验公式对比)
  □ 合理性检查 (是否符合物理直觉)
  □ 范围限制 (添加 assert 或 Saturation)
```

#### 双体船 (Catamaran) 特殊注意事项

如果本船是双体船:

```yaml
需要额外考虑:
  □ 水线面二次矩包含两个浮体
  □ 平行轴定理的影响 (I_total = 2×I_single + 2×A×d²)
  □ 浮体间距对横稳性的贡献
  □ B_pont 可能指的是"浮箱宽度"而非"总宽"
```

**建议**: 明确文档中的参数定义，避免歧义。

#### Simulink 模型维护建议

```yaml
1. 参数集中管理:
   - 使用 Simulink Data Dictionary
   - 或在 Model Workspace 中定义所有常量
   - 避免在模块中硬编码数值

2. 添加物理约束检查:
   - 在关键模块后添加 Assertion 块
   - 检查 GM > 0, omega 为实数等

3. 单位标注:
   - 在 Signal Properties 中标注单位
   - 在模块名称中包含单位信息

4. 文档化假设:
   - 在 Model Description 中记录:
     - 坐标系定义
     - 水线面形状假设 (矩形/实际型线)
     - 双体船 vs 单体船
```

### 7.3 类似问题排查流程模板

**当遇到 "导数不是有限值" 错误时**:

```
Step 1: 定位 NaN/Inf 源头
  □ 使用 Data Inspector 记录所有信号
  □ 找到第一个出现 NaN 的位置

Step 2: 检查数学运算
  □ 除零: x/0 → Inf
  □ 负数开方: sqrt(-x) → NaN
  □ 无效运算: 0/0, Inf/Inf → NaN

Step 3: 反向追溯输入
  □ 哪个输入导致了无效运算?
  □ 该输入来自哪里?
  □ 继续追溯到参数定义

Step 4: 验证参数合理性
  □ 单位检查
  □ 数量级检查
  □ 符号约定检查
  □ 物理意义检查
```

---

## 8. 关联资源 (References)

### 8.1 相关文件

```yaml
Simulink 模型:
  - ROS2_simulink_UE5_0821.slx
  - 模块路径: Subsystem/Vessel Platform/

关键子模块:
  - Input Processing/GM Calculation
  - Input Processing/Natural Frequencies
  - 6DOF (In CO)/Integrator1

参数文件:
  - (待确认参数存储位置)
  - 建议: 创建 ship_parameters.mat 或使用 Data Dictionary

验证脚本:
  - scripts/verify_gm.m (建议创建)
```

### 8.2 理论参考

#### 船舶稳性理论

- **Rawson, K. J., & Tupper, E. C.** (2001). *Basic Ship Theory* (5th ed.). Butterworth-Heinemann.
  - 第 5 章: 浮性与稳性 (Buoyancy and Stability)
  - 稳心半径公式: BM = I / ∇

- **Fossen, T. I.** (2011). *Handbook of Marine Craft Hydrodynamics and Motion Control*. Wiley.
  - 附录 A: 船舶静力学参数

#### 水线面二次矩计算

**矩形水线面**:
```
I_T = ∫∫ y² dA = (L×B³)/12  (对纵中线)
I_L = ∫∫ x² dA = (B×L³)/12  (对横中线)
```

**双体船** (两个平行矩形):
```
I_T = 2 × [(L×b³)/12 + L×b×d²]
其中: b = 单浮体宽度
      d = 浮体中心到纵中线距离
```

#### 自然频率公式

来源于简化的线性化恢复力矩:
```
M_restore = -ρ g ∇ GM × φ  (小角度假设)

线性化振动方程:
(I + I_A)φ̈ + ρ g ∇ GM × φ = 0

特征频率:
ω = √(ρ g ∇ GM / (I + I_A))
  ≈ √(g GM / (∇^(1/3)))  (简化形式)
```

### 8.3 相关文档

- `DevLogs/04_Simulation/Ship_Propeller_Trajectory_Issue.md` - 推进器轨迹问题（涉及惯性参数）
- `DevLogs/04_Simulation/UE5_Simulink_Interface.md` - 仿真接口配置

### 8.4 坐标系定义

**NED (North-East-Down) 坐标系**:
```
X: 北 (船首方向)
Y: 东 (右舷方向)
Z: 下 (垂直向下)

右手螺旋定则:
Roll (φ):  绕 X 轴旋转
Pitch (θ): 绕 Y 轴旋转
Yaw (ψ):   绕 Z 轴旋转
```

**船舶坐标系 vs 全局坐标系**:
```
Body-fixed (船体坐标系):
  - 原点通常在船中/基线/水线的交点
  - X: 船首
  - Y: 右舷
  - Z: 向下

高度参考:
  - 基线 (Baseline): Z = 0
  - 水线 (Waterline): Z = -T (吃水)
  - KB: 从基线向上
  - KG: 从基线向上
```

---

## 9. 下一步行动 (Next Steps)

### 9.1 立即行动 (必做)

- [ ] 修正 Simulink 模型中的 I_T, I_L 常量值
  - [ ] I_T: 0.12003 → 52.86 m⁴ (矩形近似)
  - [ ] I_L: 0.26667 → 6502.06 m⁴ (矩形近似)

- [ ] 确认并修正 KG 计算公式
  - [ ] 查看 rg 的定义和坐标系
  - [ ] 修改公式: `KG = T - z_G` → `KG = T + z_G` (或根据实际约定)

- [ ] 运行仿真验证
  - [ ] 检查 GM_T, GM_L 是否为正值
  - [ ] 检查自然频率是否为实数
  - [ ] 确认无 NaN 错误

### 9.2 后续优化 (建议)

- [ ] 创建参数验证脚本 `verify_gm.m`
  - [ ] 自动检查参数合理性
  - [ ] 生成 GM 诊断报告

- [ ] 如果是双体船，使用更精确的公式
  - [ ] 确认浮体布局参数
  - [ ] 应用平行轴定理修正

- [ ] 添加物理约束保护
  - [ ] 在 GM 计算后添加 Assertion 块
  - [ ] 在 Sqrt 前添加 Saturation(下限=0.01)

- [ ] 参数文档化
  - [ ] 创建船舶参数说明文档
  - [ ] 标注所有参数的来源和单位

### 9.3 长期改进

- [ ] 使用实际船型数据
  - [ ] 从型线图计算精确的 I_T, I_L
  - [ ] 或使用 CFD/浮态计算软件获取

- [ ] 建立参数数据库
  - [ ] 使用 Simulink Data Dictionary
  - [ ] 支持多船型切换

- [ ] 自动化测试
  - [ ] 添加单元测试验证 GM > 0
  - [ ] 添加集成测试验证仿真稳定性

### 9.4 文档完善

- [ ] 补充修复后的验证数据
  - [ ] 记录实际 GM 值
  - [ ] 记录自然频率值
  - [ ] 绘制频域响应曲线

- [ ] 更新 Simulink 模型文档
  - [ ] 标注坐标系定义
  - [ ] 记录参数来源
  - [ ] 添加模块说明

---

## 10. 附录 (Appendix)

### 附录 A: 关键公式汇总

#### A.1 稳性高计算

```
GM = KB + BM - KG

其中:
KB = (5/6)×T - (1/6)×(∇/(L×B))  (简化公式)
BM_T = I_T / ∇
BM_L = I_L / ∇
KG = 重心距基线高度 (取决于坐标系约定)
```

#### A.2 水线面二次矩

**矩形水线面**:
```
I_T = (L × B³) / 12  [m⁴]
I_L = (B × L³) / 12  [m⁴]
```

**双体船** (两个矩形浮体):
```
I_T = 2 × [I_T_single + A_single × d²]
    = 2 × [(L×b³)/12 + (L×b)×d²]

其中:
b = 单浮体宽度
d = 浮体中心到船体纵中线的距离
```

#### A.3 自然频率

```
ω₄₄ = √(GM_T × g / ∇^(1/3))  [rad/s]  (横摇)
ω₅₅ = √(GM_L × g / ∇^(1/3))  [rad/s]  (纵摇)

周期:
T₄₄ = 2π / ω₄₄  [s]
T₅₅ = 2π / ω₅₅  [s]
```

#### A.4 阻尼系数

```
Kp = 2 × ζ × ω × M

其中:
ζ: 阻尼比 (典型值 0.05 ~ 0.2)
ω: 自然频率 (ω₄₄ 或 ω₅₅)
M: 对应的惯性矩 (含附加质量)
```

### 附录 B: 参数合理性检查表

#### B.1 水线面二次矩检查

| 船长 L | 船宽 B | I_T (矩形) | I_L (矩形) | I_L / I_T |
|--------|--------|-----------|-----------|----------|
| 10 m | 2 m | 6.67 m⁴ | 166.7 m⁴ | 25 |
| 20 m | 3 m | 45 m⁴ | 2000 m⁴ | 44 |
| 30 m | 4 m | 160 m⁴ | 9000 m⁴ | 56 |
| **30.5 m** | **2.75 m** | **52.86 m⁴** | **6502 m⁴** | **123** ✅ |

**判断标准**:
- I_L / I_T ≈ (L/B)² (对于矩形)
- 本船: (30.5/2.75)² ≈ 123 ✅

#### B.2 重心高度检查

| 船型 | 典型 KG/T 比值 |
|------|---------------|
| 货船 | 0.5 ~ 0.7 |
| 客船 | 0.6 ~ 0.8 |
| 高速艇 | 0.4 ~ 0.6 |
| USV | 0.3 ~ 0.6 |

**本船验证**:
- 当前错误值: KG = 1.559 m, KG/T = 1.47 ❌ (超过1.0 不合理)
- 修正值: KG = 0.559 m, KG/T = 0.53 ✅ (在合理范围)

#### B.3 稳性高检查

| 船型 | 典型 GM_T 范围 |
|------|---------------|
| 大型货船 | 0.5 ~ 2.0 m |
| 中型船 | 0.3 ~ 1.5 m |
| 小型艇 | 0.2 ~ 1.0 m |
| USV (细长) | 0.5 ~ 1.5 m |

**本船验证**:
- 当前错误值: GM_T = -0.85 m ❌
- 修正值: GM_T ≈ 0.75 m ✅

### 附录 C: Simulink 模块结构图

#### C.1 GM 计算模块

```
┌────────────────────────────────────────────────┐
│           GM Calculation Module                │
├────────────────────────────────────────────────┤
│                                                │
│  输入:                                          │
│    1. Inertials (包含质量、惯量、重心位置)        │
│    2. I_T, I_L (水线面二次矩常量)               │
│    3. T, L, B, nabla (船体几何参数)             │
│                                                │
│  计算:                                          │
│    KB = (5/6)*T - (1/6)*(nabla/(L*B))         │
│    BM_T = I_T / nabla                         │
│    BM_L = I_L / nabla                         │
│    KG = f(rg(3), T)  ← 需要修正!               │
│                                                │
│    GM_T = KB + BM_T - KG                      │
│    GM_L = KB + BM_L - KG                      │
│                                                │
│  输出:                                          │
│    G_CF = [GM_T; GM_L]                        │
│                                                │
└────────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────┐
│        Natural Frequencies Module              │
├────────────────────────────────────────────────┤
│                                                │
│  w3 = sqrt(g / nabla^(1/3))                   │
│  w4 = sqrt(GM_T * g / nabla^(1/3))            │
│  w5 = sqrt(GM_L * g / nabla^(1/3))            │
│         ↑                                      │
│         └─ 如果 GM < 0 → NaN ❌                │
│                                                │
└────────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────┐
│           Damping Module                       │
├────────────────────────────────────────────────┤
│                                                │
│  Kp = 2 * zeta * diag(w) * M                  │
│       ↑           ↑                            │
│       │           └─ 如果 w 含 NaN → Kp=NaN   │
│       └─ 阻尼比 (0.05 ~ 0.2)                   │
│                                                │
└────────────────────────────────────────────────┘
```

#### C.2 错误传播路径

```
参数错误 (I_T, I_L, KG)
    ↓
BM 过小 / KG 过大
    ↓
GM < 0
    ↓
sqrt(GM) → NaN
    ↓
omega = [w3; w4; w5] 含 NaN
    ↓
Kp = 2*zeta*diag(omega)*M 含 NaN/Inf
    ↓
force_moment(4:5) = NaN
    ↓
dx/dt = M^(-1) * force_moment 含 NaN
    ↓
Integrator: 导数不是有限值
    ↓
仿真崩溃 ❌
```

---

**记录人**: Claude (AI Assistant) & CXZ
**技术审查**: 待审核
**完成日期**: 2026-01-04
**文档版本**: v1.0

---

**文档状态**: ✅ 完成 - 根因已定位，待实施修复
**最后更新**: 2026-01-04
