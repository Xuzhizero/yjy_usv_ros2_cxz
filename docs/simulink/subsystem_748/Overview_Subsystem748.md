# Subsystem (SID 748) 模块分析

## 子模块文档目录

| 子模块 | 说明 |
|--------|------|
| [Environment 环境模块](environment/Overview_environment.md) | 提供仿真所需的环境参数（如重力、流体密度、洋流速度等） |
| [Payload 载荷模块](payload/Overview_payload.md) | 提供附加载荷的质量、位置等参数，用于影响船体惯性和重心 |
| [Vessel Platform 船体平台模块](vessel_platform/Overview_vessel_platform.md) | 模拟船体本身的6自由度动力学，包括动力学方程求解及各类力的计算 |

## 模块功能概述

"Subsystem (SID 748)"模块代表整个船舶系统的物理仿真模型，包含环境影响、载荷影响以及船体动力学三大部分。该子系统综合了环境参数（如重力、水流）、载荷参数（如载荷质量、重心偏移）对船体运动的影响，并通过内部的船体平台模块计算船只在6自由度下的运动响应。

在顶层来看：

- **Environment（环境）** 子模块提供仿真所需的外部环境数据，包括重力加速度、水介质的物理性质以及洋流流速等，这些信号将作用于船体的相关力计算（如浮力、阻力等）。

- **Payload（载荷）** 子模块提供关于船上附加载荷的信息，例如载荷质量和位置，其影响船体的总质量、惯性以及重心位置，进而影响船体动力学计算（如惯性矩阵、俯仰横摇稳定性等）。

- **Vessel Platform（船体平台）** 子模块是核心的船体动力学模型，它接收来自Environment和Payload的参数，以及来自推进控制的输入，计算出船体受到的各种力和力矩，并将合力代入6自由度运动学/动力学方程求解船体的状态随时间的演变。该模块内部包括：刚体和附加质量惯性、科氏力和离心力、流体阻尼力、静浮力恢复力矩、推进力、波浪与横流附加力等各组件，并最终通过数值积分得到船体的速度、位置和姿态随时间的变化。

综上，Subsystem (748)模块实现了一个完整的船舶运动仿真：将环境和载荷影响综合到船体动力学模型中，计算船体在6DOF下的运动响应，输出船体运动状态用于后续控制或可视化。

## 输入输出信号

**Subsystem (748)** 作为顶层船体模型，一般会有以下主要接口信号：

### 输入

来自控制系统或用户的操纵指令（例如螺旋桨转速或推力命令）。这些信号通常通过ROS2接口进入，并在该子系统内传递给推进力模块，从而作用于船体模型。另有来自外部的环境参数设定（如洋流流速值、初始姿态等）通常通过上层场景(Scenario)模块或配置文件设定后注入Environment或Initial Conditions模块中。

### 输出

船体的状态量，包括船体在惯性系下的位置$(x,y,z)$、姿态角$(\phi,\theta,\psi)$以及船体在船体坐标系下的速度$\mathbf{\nu}=[u,v,w,p,q,r]^T$等。这些输出经由本子系统传递给其他模块（例如通过Simulink2ROS模块发布)，用于监视、记录或作为控制反馈。

### 内部互连信号

此外，本子系统内部各部分之间也有互连信号：

- 环境模块输出的重力常数、水密度、流速等发送到船体平台内相应模块（如静力恢复力计算、阻力计算等）。

- 载荷模块输出的载荷质量和位置发送到船体平台的惯性计算部分，用于修正惯性矩阵和重心。

- 船体平台内部各模块（水动力、静力等）计算的力和力矩最终汇总在"Sum of Forces and Moments"模块，形成合力$\tau_{\text{net}}$传递给6DOF求解器。

- 6DOF模块输出的实时状态（速度、姿态等）也反馈回某些模块，例如**Kinematics**模块需要当前姿态计算速度到惯性系的位置变化率；**Relative Velocity**模块需要当前船体速度计算相对流体速度等。

## 核心公式

Subsystem (748)模块整体上实现了典型船舶6自由度动力学方程。综合其内部各模块的作用，可用如下方程组概括船体运动模型：

**船体6DOF动力学方程（含附加质量）：**

$$(M_{RB} + M_A)\,\dot{\mathbf{\nu}} + C_{RB}(\mathbf{\nu})\,\mathbf{\nu} + C_A(\mathbf{\nu})\,\mathbf{\nu} + D(\mathbf{\nu})\,\mathbf{\nu} + \mathbf{g}(\mathbf{\eta}) = \mathbf{\tau}_{\text{thrust}} + \mathbf{\tau}_{\text{waves}}$$

其中：

- $\mathbf{\nu}=[u,v,w,p,q,r]^T$是船体坐标系下的速度向量，$\mathbf{\eta}=[x,y,z,\phi,\theta,\psi]^T$是惯性系下的位置和姿态角。

- $M_{RB}$是刚体质量惯性矩阵，$M_A$是附加质量矩阵，因此$(M_{RB}+M_A)$是总惯性矩阵。

- $C_{RB}(\mathbf{\nu})\mathbf{\nu}$和$C_A(\mathbf{\nu})\mathbf{\nu}$分别表示刚体和附加质量引起的科氏力和离心力项（随速度$\mathbf{\nu}$二次非线性）。

- $D(\mathbf{\nu})\mathbf{\nu}$表示流体阻力/阻尼力（与速度有关，含线性和非线性阻尼项）。

- $\mathbf{g}(\mathbf{\eta})$表示静浮力恢复力和重力的合力（主要与姿态角和浸润体积有关），在小角度时通常线性近似为$-G(\mathbf{\eta}_0)\tilde{\mathbf{\eta}}$，其中$G$为静力刚度矩阵，$\tilde{\mathbf{\eta}}$为偏离平衡位置的位移和角度。

- $\mathbf{\tau}_{\text{thrust}}$表示推进装置产生的力和力矩输入（如螺旋桨推力），$\mathbf{\tau}_{\text{waves}}$表示外部环境额外作用的外力，如波浪辐射力或横流附加力。

在仿真实现中，上式被拆解到各功能模块分别计算：惯性矩阵$(M_{RB}+M_A)$由惯性相关模块提供，$C_{RB}$和$C_A$由科氏力模块计算，$D$由阻尼模块计算，$\mathbf{g}(\eta)$由静水力模块计算，$\tau_{\text{thrust}}$由推进模块提供，$\tau_{\text{waves}}$由波浪/横流模块提供或当前忽略。**6DOF模块**汇总这些力并进行数值积分，求出加速度、速度和位移的演化。运动学方程部分由6DOF内部的**Kinematics**模块完成，将船体速度$\nu$通过姿态变换积分为位置和姿态角的变化。整体过程实现了对上述动力学方程的数值求解。
