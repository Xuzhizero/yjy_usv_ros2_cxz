# CourseAngle 航向角计算模块分析

## 模块功能说明

**CourseAngle（航向角）**模块计算船舶的实际运动方向角，即船舶在水平面上的速度矢量方向。航向角（Course Angle）与艏向角（Heading Angle, $\psi$）的区别在于：

- **艏向角 $\psi$**：船首指向的方向，由船体姿态决定
- **航向角 $\chi$**：船舶实际移动的方向，由速度矢量决定

当存在横漂（sideslip）或横流时，航向角与艏向角会有差异。

### 应用场景

航向角在以下场景中非常重要：
- 导航路径跟踪：需要知道船实际往哪个方向移动
- 航迹监控：记录船舶实际航行轨迹
- 侧滑角计算：$\beta = \chi - \psi$

## 输入输出端口

### 输入

- **北向速度 $V_N$**：在NED坐标系下船舶的北向（N）速度分量
- **东向速度 $V_E$**：在NED坐标系下船舶的东向（E）速度分量

或者：
- **船体速度 $\nu$**：$(u, v, w)^T$在船体坐标系下的速度
- **姿态角 $\eta$**：$(\phi, \theta, \psi)^T$用于坐标转换

### 输出

- **航向角 $\chi$**：范围通常为$[0, 2\pi)$或$[-\pi, \pi]$，单位为弧度

## 核心计算公式

### 基于NED速度计算

$$\chi = \text{atan2}(V_E, V_N)$$

使用`atan2`函数而非`atan`的原因是`atan2`可以正确处理所有四个象限，给出$[-\pi, \pi]$范围的结果。

### 坐标转换（从船体系到NED系）

如果输入是船体系速度$(u, v, w)^T$，需要先转换到NED系：

$$\begin{pmatrix} V_N \\ V_E \\ V_D \end{pmatrix} = R_{nb}(\phi, \theta, \psi) \begin{pmatrix} u \\ v \\ w \end{pmatrix}$$

其中$R_{nb}$是从船体系到NED系的旋转矩阵。

对于小横摇和纵摇角（$\phi \approx 0, \theta \approx 0$）：

$$\begin{aligned}
V_N &\approx u\cos\psi - v\sin\psi \\
V_E &\approx u\sin\psi + v\cos\psi
\end{aligned}$$

### 简化计算

对于水面船舶，假设$\phi \approx 0, \theta \approx 0$：

$$\chi = \text{atan2}(u\sin\psi + v\cos\psi, \, u\cos\psi - v\sin\psi)$$

## 航向角与艏向角的关系

### 侧滑角

侧滑角$\beta$定义为速度矢量方向与船首方向的夹角：

$$\beta = \chi - \psi = \text{atan2}(v, u)$$

（在船体系中直接计算侧滑角）

### 几何关系

```
          N (北)
          ↑
          |  χ (航向角)
          | /
          |/___→ E (东)

船首方向: ψ (艏向角)
实际运动方向: χ (航向角)
侧滑角: β = χ - ψ
```

## 特殊情况处理

### 零速度

当$V_N \approx 0$且$V_E \approx 0$时，航向角无定义。模块应：
- 输出上一时刻的航向角
- 或输出艏向角$\psi$作为默认值

### 角度跳变

当航向角跨越$\pm\pi$边界时会发生跳变。如果需要连续输出，可使用角度展开（unwrap）算法。

## 与其他模块的关系

- **6DOF模块**：提供船体速度$\nu$和姿态$\eta$
- **Kinematics模块**：提供NED系下的速度
- **Speed Norm模块**：使用相同的速度输入计算航速大小

## Simulink实现

```
输入:
  - V_N: NED北向速度 (m/s)
  - V_E: NED东向速度 (m/s)

处理:
  1. 检查速度是否接近零
  2. 如果非零: chi = atan2(V_E, V_N)
  3. 如果接近零: chi = chi_previous 或 psi

输出:
  - chi: 航向角 (rad)
```

## 计算示例

### 示例1：正北航行

- $V_N = 5$ m/s, $V_E = 0$ m/s
- $\chi = \text{atan2}(0, 5) = 0$ rad（正北方向）

### 示例2：东北方向航行

- $V_N = 3$ m/s, $V_E = 4$ m/s
- $\chi = \text{atan2}(4, 3) = 0.927$ rad ≈ 53.1°（东偏北53.1°）

### 示例3：带侧滑的直线航行

假设船首朝正北（$\psi = 0$），但有横向漂移：
- $u = 5$ m/s（前进速度）
- $v = 1$ m/s（横向速度，向右漂）

则：
- $V_N = 5\cos(0) - 1\sin(0) = 5$ m/s
- $V_E = 5\sin(0) + 1\cos(0) = 1$ m/s
- $\chi = \text{atan2}(1, 5) = 0.197$ rad ≈ 11.3°

船首朝北，但实际航向偏东11.3°，侧滑角$\beta = 11.3°$。

## 注意事项

1. **角度单位**：确保输出角度单位（弧度或度）与下游模块一致

2. **角度范围**：根据应用需求选择$[0, 2\pi)$或$[-\pi, \pi]$范围

3. **数值稳定性**：当速度接近零时避免除零错误

4. **滤波**：实际应用中可能需要对航向角进行低通滤波以减少噪声

## 总结

CourseAngle模块是导航系统的基本输出之一。它将船舶的速度信息转换为直观的方向角，便于监控和控制。正确区分航向角和艏向角对于理解船舶的实际运动状态非常重要，特别是在存在侧滑或横流的情况下。
