# 系统架构 (System Architecture)

**Tags:** `architecture`, `design`, `system-structure`, `modules`, `ros2-nodes`

**最后更新**: 2025-12-16

---

## 目录

- [系统架构 (System Architecture)](#系统架构-system-architecture)
  - [目录](#目录)
  - [1. 整体架构](#1-整体架构)
    - [1.1 架构图](#11-架构图)
    - [1.2 分层设计](#12-分层设计)
  - [2. ROS2 节点架构](#2-ros2-节点架构)
    - [2.1 核心节点](#21-核心节点)
    - [2.2 节点关系图](#22-节点关系图)
  - [3. 控制系统模块](#3-控制系统模块)
    - [3.1 控制器模块](#31-控制器模块)
    - [3.2 制导模块](#32-制导模块)
    - [3.3 推力分配模块](#33-推力分配模块)
  - [4. 导航与规划模块](#4-导航与规划模块)
    - [4.1 路径规划](#41-路径规划)
    - [4.2 制导律](#42-制导律)
  - [5. 仿真模块](#5-仿真模块)
    - [5.1 USV 动力学仿真](#51-usv-动力学仿真)
    - [5.2 UE5 接口](#52-ue5-接口)
    - [5.3 Simulink 接口](#53-simulink-接口)
  - [6. 数据流](#6-数据流)
    - [6.1 主要话题](#61-主要话题)
    - [6.2 自定义消息](#62-自定义消息)
  - [7. 配置与参数](#7-配置与参数)
  - [8. 扩展性设计](#8-扩展性设计)
  - [9. 性能考量](#9-性能考量)
  - [10. 安全性设计](#10-安全性设计)

---

## 1. 整体架构

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户交互层 (User Layer)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  键盘控制    │  │   RViz2      │  │  数据可视化   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  应用层 (Application Layer)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  路径规划    │  │  目标跟随    │  │  自主导航    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  控制层 (Control Layer)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ PID 控制器   │  │ MFAC 控制器  │  │ S-plane 控制 │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │ LOS 制导     │  │  推力分配    │                        │
│  └──────────────┘  └──────────────┘                        │
└─────────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  执行层 (Execution Layer)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  左推进器    │  │  右推进器    │  │   舵机       │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                  仿真层 (Simulation Layer)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ USV 动力学   │  │     UE5      │  │  Simulink    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 分层设计

| 层级 | 职责 | 主要组件 |
|------|------|----------|
| **用户交互层** | 人机交互接口 | 键盘控制、可视化工具 |
| **应用层** | 高层任务逻辑 | 路径规划、任务调度 |
| **控制层** | 运动控制算法 | 各类控制器、制导律 |
| **执行层** | 物理执行机构 | 推进器、舵机 |
| **仿真层** | 虚拟环境模拟 | 动力学模型、3D 仿真 |

---

## 2. ROS2 节点架构

### 2.1 核心节点

| 节点名称 | 功能描述 | 发布话题 | 订阅话题 |
|----------|----------|----------|----------|
| `usvSim` | USV 动力学仿真 | `/usv/state`, `/usv/pose` | `/usv/thrust_cmd` |
| `pidController` | PID 控制器 | `/control/thrust_cmd` | `/usv/state`, `/path/target` |
| `losGuidance` | LOS 制导律 | `/guidance/target_heading` | `/path/waypoints`, `/usv/pose` |
| `thrustAllocation` | 推力分配 | `/motor/left`, `/motor/right` | `/control/thrust_cmd` |
| `pathGenerator` | 路径生成器 | `/path/waypoints` | `/mission/goal` |
| `keyboardInteraction` | 键盘控制 | `/usv/manual_cmd` | - |

### 2.2 节点关系图

```
    ┌─────────────┐
    │ pathGenerator│
    └──────┬──────┘
           │ /path/waypoints
           ▼
    ┌─────────────┐     /guidance/target_heading    ┌─────────────┐
    │ losGuidance │ ───────────────────────────────▶│pidController│
    └──────┬──────┘                                  └──────┬──────┘
           │                                                │
           │ subscribes: /usv/pose                          │ /control/thrust_cmd
           │                                                ▼
    ┌──────▼────────────────────────────────────────┬─────────────┐
    │                                                │thrustAlloc  │
    │              usvSim                            └──────┬──────┘
    │                                                       │
    │  publishes: /usv/state, /usv/pose                    │ /motor/left
    └───────────────────────────────────────────────────────┴─────────┘
                                                             /motor/right
```

---

## 3. 控制系统模块

### 3.1 控制器模块

#### PID 控制器

**文件**: `control_planner/PIDControl.py`

```python
class PIDController:
    """
    经典 PID 控制器实现
    - 航向控制
    - 速度控制
    - 位置控制
    """
```

**参数配置**: `control_planner/PIDParam.py`

#### MFAC 控制器

**文件**: `control_planner/MFACControl.py`

```python
class MFACController:
    """
    无模型自适应控制器
    - 在线参数辨识
    - 自适应增益调节
    """
```

#### S-plane 控制器

**文件**: `control_planner/SplaneControl.py`

```python
class SplaneController:
    """
    基于 S-平面的非线性控制
    - 滑模控制
    - 反步法控制
    """
```

### 3.2 制导模块

**LOS 制导律** (`LOSguidance.py`)

- 纯跟踪制导
- 积分 LOS
- 自适应前视距离

### 3.3 推力分配模块

**文件**: `thrustAllocation.py`

- 双推进器差动控制
- 推力优化分配
- 推力限幅保护

---

## 4. 导航与规划模块

### 4.1 路径规划

**曲线生成器** (`curveGenerator.py`)

- 直线路径
- 圆弧路径
- B样条曲线
- 自定义航点序列

### 4.2 制导律

- **LOS 制导**: 适用于直线段跟踪
- **纯跟踪**: 适用于曲线跟踪
- **目标跟随**: 动态目标锁定

---

## 5. 仿真模块

### 5.1 USV 动力学仿真

**文件**: `usvDynamics.py`, `usvSim.py`

**模型**:
- 3-DOF 运动学模型（surge, sway, yaw）
- 环境干扰（风、流）
- 推进器动态模型

### 5.2 UE5 接口

**功能**:
- 高保真度视觉渲染
- 传感器仿真（相机、激光雷达）
- 物理碰撞检测

### 5.3 Simulink 接口

**功能**:
- 与 MATLAB 协同仿真
- 参数整定工具
- 批量实验运行

---

## 6. 数据流

### 6.1 主要话题

| 话题名称 | 消息类型 | 频率 | 描述 |
|----------|----------|------|------|
| `/usv/state` | `geometry_msgs/Twist` | 50Hz | USV 状态（位置、速度、航向） |
| `/usv/pose` | `geometry_msgs/PoseStamped` | 50Hz | USV 位姿 |
| `/control/thrust_cmd` | `pid_interfaces/Command` | 50Hz | 控制指令 |
| `/motor/left` | `std_msgs/Float64` | 50Hz | 左推进器推力 |
| `/motor/right` | `std_msgs/Float64` | 50Hz | 右推进器推力 |
| `/path/waypoints` | `nav_msgs/Path` | 1Hz | 航点序列 |

### 6.2 自定义消息

**Command.msg** (`pid_interfaces/msg/Command.msg`)

```
float64 surge_force      # 纵向力
float64 yaw_moment       # 偏航力矩
float64 target_speed     # 目标速度
float64 target_heading   # 目标航向
```

---

## 7. 配置与参数

**参数文件位置**: `src/control_planner/param/`

- `nav2_params.yaml`: 导航参数
- `joint_init.yaml`: 初始关节角度
- `costmap_common_params.yaml`: 代价地图配置

---

## 8. 扩展性设计

### 插件式控制器

```python
# 自定义控制器只需继承基类
class MyController(ControllerBase):
    def compute_control(self, state, target):
        # 实现控制逻辑
        pass
```

### 模块化传感器接口

```python
# 添加新传感器
class MySensor(SensorBase):
    def read_data(self):
        # 读取传感器数据
        pass
```

---

## 9. 性能考量

- **实时性**: 控制循环 50Hz
- **通信延迟**: < 10ms (局域网)
- **计算资源**: 单核 CPU 占用率 < 30%

---

## 10. 安全性设计

- **推力限幅**: 防止过载
- **超时保护**: 通信中断自动停机
- **边界检查**: 防止越界
- **故障恢复**: 自动重连机制

---

**相关文档**:
- [项目概览](overview.md)
- [使用指南](usage.md)
- [ROS2 节点集成日志](../DevLogs/03_ROS2/Node_Integration.md)
